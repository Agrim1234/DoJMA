package com.csatimes.dojma;import android.annotation.TargetApi;import android.app.Activity;import android.app.NotificationManager;import android.app.PendingIntent;import android.content.BroadcastReceiver;import android.content.Context;import android.content.Intent;import android.content.IntentFilter;import android.content.SharedPreferences;import android.content.res.Configuration;import android.graphics.BitmapFactory;import android.graphics.Color;import android.net.Uri;import android.os.Build;import android.os.Bundle;import android.support.annotation.Nullable;import android.support.annotation.RequiresApi;import android.support.customtabs.CustomTabsIntent;import android.support.design.widget.Snackbar;import android.support.v4.app.Fragment;import android.support.v4.content.ContextCompat;import android.support.v4.widget.SwipeRefreshLayout;import android.support.v7.widget.DefaultItemAnimator;import android.support.v7.widget.GridLayoutManager;import android.support.v7.widget.LinearLayoutManager;import android.support.v7.widget.RecyclerView;import android.support.v7.widget.SearchView;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.Button;import android.widget.EditText;import com.csatimes.dojma.models.HeraldNewsItemFormat;import com.turingtechnologies.materialscrollbar.DragScrollBar;import io.realm.Case;import io.realm.Realm;import io.realm.RealmConfiguration;import io.realm.RealmList;import io.realm.RealmResults;import io.realm.Sort;public class Herald extends Fragment implements SearchView.OnQueryTextListener,        SwipeRefreshLayout.OnRefreshListener {    public HeraldRV adapter;    private EditText searchEditText;    private boolean landscape = false;    private RecyclerView heraldRecyclerView;    private SharedPreferences preferences;    private Realm database;    private RealmConfiguration realmConfiguration;    private SearchView searchView;    private RealmResults<HeraldNewsItemFormat> results;    private RealmList<HeraldNewsItemFormat> resultsList;    private SwipeRefreshLayout swipeRefreshLayout;    BroadcastReceiver broadcastReceiver = new BroadcastReceiver() {        @Override        public void onReceive(Context context, Intent intent) {            //Show snackbar to notify user that update check completed but            //no articles were downloaded.            //Also since Update service is fired every time in onStop of HomeActivity            //we add a check for swipelayout's refresh status            //If user had initiated refreshing only then show snackbar            //CODE FOLDED HERE            if (intent.getAction().compareTo(UpdateCheckerService.UPDATE_CHECK_OVER) == 0 &&                    swipeRefreshLayout.isRefreshing()) {                swipeRefreshLayout.setRefreshing(false);                try {                    Snackbar.make(heraldRecyclerView, "No updates available", Snackbar.LENGTH_SHORT)                            .show();                } catch (Exception e) {                    //Snackbar requires non null view,so if that fails we get the log                    Log.e("TAG", "RecyclerView is null");                }            } else if (intent.getAction().compareTo(UpdateCheckerService.DOWNLOAD_SUCCESS_ACTION) == 0) {                //cancel any pending intent and notification                Intent openHerald = new Intent(context, HomeActivity.class);                PendingIntent.getActivity(context, DHC.UPDATE_SERVICE_PENDING_INTENT_CODE, openHerald, PendingIntent.FLAG_CANCEL_CURRENT).cancel();                NotificationManager notificationManager = (NotificationManager) getActivity().getSystemService(Context.NOTIFICATION_SERVICE);                notificationManager.cancel(DHC.UPDATE_SERVICE_NOTIFICATION_CODE);                //update ui                try {                    if (resultsList.size() != 0 && adapter != null) {                        resultsList.clear();                        resultsList.addAll(database.where(HeraldNewsItemFormat.class).findAllSorted                                ("originalDate", Sort.DESCENDING));                        adapter.notifyDataSetChanged();                        try {                            Snackbar.make(heraldRecyclerView, "Articles were updated", Snackbar                                    .LENGTH_SHORT)                                    .show();                        } catch (Exception e) {                            //Snackbar requires non null view,so if that fails we get the log                            Log.e("TAG", "RecyclerView is null");                        }                    }                } catch (Exception e) {                    Log.e("TAG", "Exception");                } finally {                    swipeRefreshLayout.setRefreshing(false);                }            }            if (intent.getAction().equalsIgnoreCase(ImageUrlHandlerService.IMAGE_SERVICE_SUCCESS)) {                adapter.notifyDataSetChanged();            }        }    };    private DragScrollBar dragScrollBar;    private Context context;    public Herald() {        // Required empty public constructor    }    @Override    public void onCreate(@Nullable Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        landscape = getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE;        preferences = getContext().getSharedPreferences(DHC.USER_PREFERENCES,                Context.MODE_PRIVATE);    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        context = getContext();        View V = inflater.inflate(R.layout.fragment_herald, container, false);        if (!landscape) {            searchView = (SearchView) V.findViewById(R.id.herald_search_view);            searchEditText = (EditText) searchView.findViewById(android.support.v7.appcompat.R.id.search_src_text);        }        heraldRecyclerView = (RecyclerView) V.findViewById(R.id.herald_recycler_view);        swipeRefreshLayout = (SwipeRefreshLayout) V.findViewById(R.id.swipe_refresh_container);        if (!landscape) {            searchEditText.setTextColor(Color.WHITE);            searchEditText.setHintTextColor(Color.parseColor("#44FFFFFF"));            searchView.setIconifiedByDefault(false);            searchView.setIconified(false);            searchView.clearFocus();        }        realmConfiguration = new RealmConfiguration.Builder(context)                .name                        (DHC.REALM_DOJMA_DATABASE).deleteRealmIfMigrationNeeded().build();        Realm.setDefaultConfiguration(realmConfiguration);        database = Realm.getDefaultInstance();        results = database.where(HeraldNewsItemFormat.class).equalTo("dismissed", false)                .findAllSorted("originalDate", Sort.DESCENDING);        resultsList = new RealmList<>();        resultsList = new RealmList<>();        resultsList.addAll(results);        adapter = new HeraldRV(context, resultsList, database, getActivity());        adapter.setGoogleChromeInstalled(preferences.getBoolean(getString(R.string.SP_chrome_install_status), false));        dragScrollBar = new DragScrollBar(context, heraldRecyclerView, true)                .setDraggableFromAnywhere(true).setHandleColour(ContextCompat.getColor(getContext                        (), R.color.colorAccent))/*.addIndicator(new DateAndTimeIndicator(getContext                        (), true, true, true, false), true)*/.setBarColour(ContextCompat.getColor                        (context, R.color.grey500)).setHandleOffColour(ContextCompat.getColor                        (context, R.color.colorAccent)).setTextColour(Color                        .WHITE);        heraldRecyclerView.setHasFixedSize(true);        if (!landscape) {            LinearLayoutManager linearLayoutManager = new LinearLayoutManager(context);            linearLayoutManager.setOrientation(LinearLayoutManager.VERTICAL);            heraldRecyclerView.setLayoutManager(linearLayoutManager);            heraldRecyclerView.setAdapter(adapter);        } else {            heraldRecyclerView.setLayoutManager(new GridLayoutManager(context, 2, LinearLayoutManager.VERTICAL, false));            adapter.setLandscape(true);            heraldRecyclerView.setAdapter(adapter);        }        heraldRecyclerView.setItemAnimator(new DefaultItemAnimator());        heraldRecyclerView.setAdapter(adapter);        swipeRefreshLayout.setColorSchemeResources(R.color.amber500, R.color.blue500, R.color                .brown500, R.color.cyan500, R.color.deeporange500, R.color.deepPurple500, R.color.green500, R                .color.grey500, R.color.indigo500, R.color.lightblue500, R.color.lime500, R.color                .orange500, R.color.pink500, R.color.red500, R.color.teal500, R.color.violet500, R                .color.yellow500);        swipeRefreshLayout.setOnRefreshListener(this);        if (!landscape) {            searchView.setOnQueryTextListener(this);        }        return V;    }    @Override    public void onResume() {        super.onResume();        if (!landscape) {            searchView.clearFocus();        }        IntentFilter intf = new IntentFilter();        intf.addAction(UpdateCheckerService.DOWNLOAD_SUCCESS_ACTION);        intf.addAction(UpdateCheckerService.UPDATE_CHECK_OVER);        getActivity().registerReceiver(broadcastReceiver, intf);    }    @Override    public void onPause() {        getActivity().unregisterReceiver(broadcastReceiver);        if (!landscape) {            searchView.clearFocus();        }        super.onPause();    }    @Override    public boolean onQueryTextSubmit(String query) {        results = database.where(HeraldNewsItemFormat.class).equalTo("dismissed", false)                .beginGroup()                .contains("title", query, Case.INSENSITIVE)                .or()                .contains("postID", query, Case.INSENSITIVE)                .or()                .contains("content", query, Case.INSENSITIVE)                .endGroup()                .findAllSorted("originalDate", Sort.DESCENDING);        resultsList.clear();        resultsList.addAll(results);        if (resultsList.size() != 0) {            adapter.notifyDataSetChanged();            dragScrollBar.setVisibility(View.VISIBLE);        } else {            dragScrollBar.setVisibility(View.GONE);        }        return true;    }    @Override    public boolean onQueryTextChange(String newText) {        resultsList.clear();        resultsList.addAll(database                .where(HeraldNewsItemFormat.class)                .equalTo("dismissed", false)                .beginGroup().contains("title", newText, Case.INSENSITIVE)                .or()                .contains("postID", newText, Case.INSENSITIVE)                .or()                .contains("content", newText, Case.INSENSITIVE)                .endGroup()                .findAllSorted("originalDate", Sort.DESCENDING));        if (resultsList.size() != 0) {            adapter.notifyDataSetChanged();            dragScrollBar.setVisibility(View.VISIBLE);        } else {            dragScrollBar.setVisibility(View.GONE);        }        return true;    }    @Override    public void onRefresh() {        if (UpdateCheckerService.instance == null) {            if (ImageUrlHandlerService.instance == null) {                final Intent intent = new Intent(context, UpdateCheckerService.class);                context.startService(intent);            } else {                swipeRefreshLayout.setRefreshing(false);                Snackbar.make(swipeRefreshLayout, "Update check is already in progress", Snackbar                        .LENGTH_SHORT).show();            }        } else {            swipeRefreshLayout.setRefreshing(false);            Snackbar.make(swipeRefreshLayout, "Update check is already in progress", Snackbar                    .LENGTH_SHORT).show();        }    }}